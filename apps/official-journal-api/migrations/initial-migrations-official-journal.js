'use strict'

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface) {
    return await queryInterface.sequelize.query(`
    BEGIN;

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    CREATE TABLE IF NOT EXISTS USER_ROLE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS OJOI_USER (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      NATIONAL_ID VARCHAR NOT NULL,
      FIRST_NAME VARCHAR NOT NULL,
      LAST_NAME VARCHAR NOT NULL,
      DISPLAY_NAME VARCHAR NOT NULL,
      EMAIL VARCHAR NOT NULL,
      ROLE_ID UUID NOT NULL,
      DELETED_AT TIMESTAMP DEFAULT NULL,
      CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID),
      CONSTRAINT FK_USER_ROLE_ID FOREIGN KEY (ROLE_ID) REFERENCES USER_ROLE (ID),
      CONSTRAINT NATIONAL_ID_UNIQUE UNIQUE (NATIONAL_ID)
    );

    -- "Deildir og tegundir"
    CREATE TABLE IF NOT EXISTS ADVERT_DEPARTMENT (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL UNIQUE,
      SLUG VARCHAR NOT NULL UNIQUE,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_MAIN_TYPE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL UNIQUE,
      DEPARTMENT_ID UUID NOT NULL,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      CONSTRAINT FK_ADVERT_MAIN_TYPE_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID),
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_TYPE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL UNIQUE,
      DEPARTMENT_ID UUID NOT NULL,
      MAIN_TYPE_ID UUID,
      LEGACY_ID UUID,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      CONSTRAINT SLUG_UNIQUE UNIQUE (SLUG),
      CONSTRAINT FK_ADVERT_TYPE_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID),
      CONSTRAINT FK_ADVERT_TYPE_MAIN_TYPE_ID FOREIGN KEY (MAIN_TYPE_ID) REFERENCES ADVERT_MAIN_TYPE (ID),
      PRIMARY KEY (ID)
    );

    -- "Yfirflokkur"
    CREATE TABLE IF NOT EXISTS ADVERT_MAIN_CATEGORY (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL UNIQUE,
      DEPARTMENT_ID UUID NOT NULL,
      DESCRIPTION VARCHAR NOT NULL,
      PRIMARY KEY (ID),
      CONSTRAINT FK_ADVERT_MAIN_CATEGORY_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_CATEGORY (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID)
    );

    -- "Main category" to "Category" relation
    CREATE TABLE IF NOT EXISTS CATEGORY_CATEGORIES (
      ADVERT_CATEGORY_ID UUID NOT NULL,
      ADVERT_MAIN_CATEGORY_ID UUID NOT NULL,
      PRIMARY KEY (ADVERT_CATEGORY_ID, ADVERT_MAIN_CATEGORY_ID),
      CONSTRAINT FK_CATEGORIES_ADVERT_CATEGORY_ID FOREIGN KEY (ADVERT_CATEGORY_ID) REFERENCES ADVERT_CATEGORY (ID),
      CONSTRAINT FK_CATEGORIES_ADVERT_MAIN_CATEGORY_ID FOREIGN KEY (ADVERT_MAIN_CATEGORY_ID) REFERENCES ADVERT_MAIN_CATEGORY (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_STATUS (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_INVOLVED_PARTY (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      NATIONAL_ID VARCHAR DEFAULT NULL,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      CONSTRAINT ADVERT_INVOLVED_PARTY_TITLE_SLUG_UNIQUE UNIQUE (TITLE, SLUG, NATIONAL_ID),
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      DEPARTMENT_ID UUID NOT NULL,
      TYPE_ID UUID NOT NULL,
      SUBJECT VARCHAR NOT NULL,
      STATUS_ID UUID NOT NULL,
      SERIAL_NUMBER INTEGER NOT NULL CHECK (SERIAL_NUMBER > 0),
      PUBLICATION_YEAR INTEGER NOT NULL CHECK (
        PUBLICATION_YEAR > 1900
        AND PUBLICATION_YEAR < 2100
      ),
      SIGNATURE_DATE TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PUBLICATION_DATE TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      INVOLVED_PARTY_ID UUID NOT NULL,
      IS_LEGACY BOOLEAN DEFAULT FALSE,
      DOCUMENT_HTML TEXT NOT NULL,
      DOCUMENT_PDF_URL VARCHAR,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID),
      CONSTRAINT FK_ADVERT_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID),
      CONSTRAINT FK_ADVERT_TYPE_ID FOREIGN KEY (TYPE_ID) REFERENCES ADVERT_TYPE (ID),
      CONSTRAINT FK_ADVERT_STATUS_ID FOREIGN KEY (STATUS_ID) REFERENCES ADVERT_STATUS (ID),
      CONSTRAINT FK_ADVERT_INVOLVED_PARTY_ID FOREIGN KEY (INVOLVED_PARTY_ID) REFERENCES ADVERT_INVOLVED_PARTY (ID),
      CONSTRAINT ADVERT_SERIAL_NUMBER_PUBLICATION_YEAR_DEPARTMENT_UNIQUE UNIQUE (SERIAL_NUMBER, PUBLICATION_YEAR, DEPARTMENT_ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_CORRECTION (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      ADVERT_ID UUID NOT NULL,
      TITLE VARCHAR NOT NULL,
      DESCRIPTION VARCHAR NOT NULL,
      DOCUMENT_HTML TEXT NOT NULL,
      DOCUMENT_PDF_URL VARCHAR,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID),
      CONSTRAINT FK_ADVERT_CORRECTION_ADVERT_ID FOREIGN KEY (ADVERT_ID) REFERENCES ADVERT (ID) ON DELETE CASCADE
    );

    CREATE TABLE IF NOT EXISTS ADVERT_CATEGORIES (
      ADVERT_ID UUID NOT NULL,
      CATEGORY_ID UUID NOT NULL,
      PRIMARY KEY (ADVERT_ID, CATEGORY_ID),
      CONSTRAINT FK_ADVERT_CATEGORIES_ADVERT_ID FOREIGN KEY (ADVERT_ID) REFERENCES ADVERT (ID),
      CONSTRAINT FK_ADVERT_CATEGORIES_CATEGORY_ID FOREIGN KEY (CATEGORY_ID) REFERENCES ADVERT_CATEGORY (ID)
    );

    CREATE TABLE IF NOT EXISTS ADVERT_ATTACHMENTS (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      ADVERT_ID UUID NOT NULL,
      NAME VARCHAR NOT NULL,
      TYPE VARCHAR NOT NULL,
      URL VARCHAR NOT NULL,
      PRIMARY KEY (ID),
      CONSTRAINT FK_ADVERT_ATTACHMENTS FOREIGN KEY (ADVERT_ID) REFERENCES ADVERT (ID)
    );

    CREATE TABLE IF NOT EXISTS CATEGORY_DEPARTMENT (
      CATEGORY_ID UUID NOT NULL,
      DEPARTMENT_ID UUID NOT NULL,
      PRIMARY KEY (CATEGORY_ID, DEPARTMENT_ID),
      CONSTRAINT FK_CATEGORY_DEPARTMENT_CATEGORY_ID FOREIGN KEY (CATEGORY_ID) REFERENCES ADVERT_CATEGORY (ID),
      CONSTRAINT FK_CATEGORY_DEPARTMENT_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_STATUS (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_TAG (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_COMMUNICATION_STATUS (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_COMMENT_TYPE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_CHANNEL (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      NAME VARCHAR NOT NULL,
      EMAIL VARCHAR NOT NULL,
      PHONE VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS APPLICATION_FEE_CODES (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4(),
      FEE_CODE VARCHAR NOT NULL,
      DESCRIPTION VARCHAR NOT NULL,
      FEE_TYPE VARCHAR NOT NULL,
      VALUE NUMERIC NOT NULL,
      DEPARTMENT VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_TRANSACTION (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4(),
      CASE_ID UUID NOT NULL UNIQUE,
      EXTERNAL_REFERENCE VARCHAR NOT NULL,
      TOTAL_PRICE NUMERIC NOT NULL,
      FEE_CODES TEXT[],
      CUSTOM_UNIT_BASE_COUNT NUMERIC,
      CUSTOM_UNIT_ADDITIONAL_CHARACTER_COUNT NUMERIC,
      CUSTOM_UNIT_ADDITIONAL_DOC_COUNT NUMERIC,
      IMAGE_TIER_CODE VARCHAR,
      CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_CASE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      ADVERT_ID UUID,
      APPLICATION_ID UUID,
      YEAR INTEGER NOT NULL,
      CASE_NUMBER VARCHAR NOT NULL,
      STATUS_ID UUID NOT NULL,
      TAG_ID UUID,
      INVOLVED_PARTY_ID UUID,
      CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      IS_LEGACY BOOLEAN NOT NULL DEFAULT FALSE,
      ASSIGNED_USER_ID UUID,
      CASE_COMMUNICATION_STATUS_ID UUID,
      PUBLISHED_AT TIMESTAMP WITH TIME ZONE,
      TRANSACTION_ID UUID NULL,
      FAST_TRACK BOOLEAN DEFAULT FALSE,
      DEPARTMENT_ID UUID NOT NULL,
      ADVERT_TITLE VARCHAR NOT NULL,
      MESSAGE TEXT,
      ADVERT_REQUESTED_PUBLICATION_DATE TIMESTAMP WITH TIME ZONE,
      ADVERT_TYPE_ID UUID NOT NULL,
      ADVERT_HTML TEXT NOT NULL,
      PUBLICATION_NUMBER VARCHAR,
      CONSTRAINT FK_CASE_CASE_STATUS_ID FOREIGN KEY (STATUS_ID) REFERENCES CASE_STATUS (ID),
      CONSTRAINT FK_CASE_CASE_TAG_ID FOREIGN KEY (TAG_ID) REFERENCES CASE_TAG (ID),
      CONSTRAINT FK_CASE_CASE_INVOLVED_PARTY_ID FOREIGN KEY (INVOLVED_PARTY_ID) REFERENCES ADVERT_INVOLVED_PARTY (ID),
      CONSTRAINT FK_CASE_CASE_COMMUNICATION_STATUS_ID FOREIGN KEY (CASE_COMMUNICATION_STATUS_ID) REFERENCES CASE_COMMUNICATION_STATUS (ID),
      CONSTRAINT FK_CASE_CASE_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID),
      CONSTRAINT FK_CASE_CASE_ADVERT_TYPE_ID FOREIGN KEY (ADVERT_TYPE_ID) REFERENCES ADVERT_TYPE (ID),
      CONSTRAINT FK_CASE_CASE_ADVERT_ID FOREIGN KEY (ADVERT_ID) REFERENCES ADVERT (ID),
      CONSTRAINT FK_CASE_CASE_ASSIGNED_USER_ID FOREIGN KEY (ASSIGNED_USER_ID) REFERENCES OJOI_USER (ID),
      CONSTRAINT FK_CASE_TRANSACTION FOREIGN KEY (TRANSACTION_ID) REFERENCES CASE_TRANSACTION (ID) ON DELETE RESTRICT,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_COMMENT (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      CASE_ID UUID NOT NULL,
      CASE_STATUS_ID UUID NOT NULL,
      TYPE_ID UUID NOT NULL,
      SOURCE VARCHAR NOT NULL,
      INTERNAL BOOLEAN DEFAULT TRUE,
      APPLICATION_STATE JSONB,
      CREATOR TEXT,
      RECEIVER TEXT,
      COMMENT TEXT,
      PRIMARY KEY (ID),
      CONSTRAINT FK_CASE_COMMENT_CASE_ID FOREIGN KEY (CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_COMMENT_CASE_STATUS_ID FOREIGN KEY (CASE_STATUS_ID) REFERENCES CASE_STATUS (ID),
      CONSTRAINT FK_CASE_COMMENT_TYPE_ID FOREIGN KEY (TYPE_ID) REFERENCES CASE_COMMENT_TYPE (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_CATEGORIES (
      CASE_CASE_ID UUID NOT NULL,
      CATEGORY_ID UUID NOT NULL,
      PRIMARY KEY (CASE_CASE_ID, CATEGORY_ID),
      CONSTRAINT FK_CASE_CATEGORIES_CASE_ID FOREIGN KEY (CASE_CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_CATEGORIES_CATEGORY_ID FOREIGN KEY (CATEGORY_ID) REFERENCES ADVERT_CATEGORY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_CHANNELS (
      CASE_CASE_ID UUID NOT NULL,
      CASE_CHANNEL_ID UUID NOT NULL,
      PRIMARY KEY (CASE_CASE_ID, CASE_CHANNEL_ID),
      CONSTRAINT FK_CASE_CHANNELS_CASE_ID FOREIGN KEY (CASE_CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_CHANNELS_CHANNEL_ID FOREIGN KEY (CASE_CHANNEL_ID) REFERENCES CASE_CHANNEL (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_COMMENTS (
      CASE_CASE_ID UUID NOT NULL,
      CASE_COMMENT_ID UUID NOT NULL,
      PRIMARY KEY (CASE_CASE_ID, CASE_COMMENT_ID),
      CONSTRAINT FK_CASE_COMMENTS_CASE_ID FOREIGN KEY (CASE_CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_COMMENTS_COMMENT_ID FOREIGN KEY (CASE_COMMENT_ID) REFERENCES CASE_COMMENT (ID)
    );

    CREATE TABLE IF NOT EXISTS SIGNATURE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      DATE TIMESTAMP WITH TIME ZONE NOT NULL,
      HTML TEXT NOT NULL,
      INVOLVED_PARTY_ID UUID NOT NULL,
      CASE_ID UUID NOT NULL UNIQUE,
      ADVERT_ID UUID,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID),
      CONSTRAINT FK_SIGNATURE_INVOLVED_PARTY_ID FOREIGN KEY (INVOLVED_PARTY_ID) REFERENCES ADVERT_INVOLVED_PARTY (ID),
      CONSTRAINT FK_SIGNATURE_CASE_ID FOREIGN KEY (CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_SIGNATURE_ADVERT_ID FOREIGN KEY (ADVERT_ID) REFERENCES ADVERT (ID)
    );

    CREATE TABLE IF NOT EXISTS SIGNATURE_RECORD (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      INSTITUTION VARCHAR NOT NULL,
      DATE TIMESTAMP WITH TIME ZONE NOT NULL,
      ADDITIONAL_SIGNATURE TEXT,
      CHAIRMAN_ID UUID,
      SIGNATURE_ID UUID NOT NULL,
      PRIMARY KEY (ID),
      CONSTRAINT FK_SIGNATURE_ID FOREIGN KEY (SIGNATURE_ID) REFERENCES SIGNATURE (ID)
    );

    CREATE TABLE IF NOT EXISTS SIGNATURE_MEMBER (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      SIGNATURE_RECORD_ID UUID NOT NULL,
      TEXT_ABOVE TEXT,
      TEXT_BEFORE TEXT,
      TEXT_BELOW TEXT,
      TEXT_AFTER TEXT,
      NAME TEXT NOT NULL,
      CREATED TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS APPLICATION_ATTACHMENT_TYPE (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS APPLICATION_ATTACHMENT (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      APPLICATION_ID UUID NOT NULL,
      ORIGINAL_FILE_NAME VARCHAR NOT NULL,
      FILE_NAME VARCHAR NOT NULL,
      FILE_FORMAT VARCHAR NOT NULL,
      FILE_EXTENSION VARCHAR NOT NULL,
      FILE_SIZE INTEGER NOT NULL,
      FILE_LOCATION VARCHAR NOT NULL,
      TYPE_ID UUID NOT NULL,
      DELETED BOOLEAN DEFAULT FALSE,
      PRIMARY KEY (ID),
      CONSTRAINT FK_APPLICATION_ATTACHMENT_TYPE_ID FOREIGN KEY (TYPE_ID) REFERENCES APPLICATION_ATTACHMENT_TYPE (ID)
    );

    CREATE TABLE IF NOT EXISTS APPLICATION_ATTACHMENTS (
      APPLICATION_ID UUID NOT NULL,
      ATTACHMENT_ID UUID NOT NULL,
      PRIMARY KEY (APPLICATION_ID, ATTACHMENT_ID),
      CONSTRAINT FK_APPLICATION_ATTACHMENTS_APPLICATION_ID FOREIGN KEY (ATTACHMENT_ID) REFERENCES APPLICATION_ATTACHMENT (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_ATTACHMENTS (
      CASE_CASE_ID UUID NOT NULL,
      ATTACHMENT_ID UUID NOT NULL,
      PRIMARY KEY (CASE_CASE_ID, ATTACHMENT_ID),
      CONSTRAINT FK_CASE_ATTACHMENTS_CASE_ID FOREIGN KEY (CASE_CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_ATTACHMENTS_ATTACHMENT_ID FOREIGN KEY (ATTACHMENT_ID) REFERENCES APPLICATION_ATTACHMENT (ID)
    );

    CREATE TABLE IF NOT EXISTS PUBLISHED_CASE_ADVERTS (
      CASE_ID UUID NOT NULL,
      ADVERT_ID UUID NOT NULL,
      PRIMARY KEY (CASE_ID, ADVERT_ID),
      CONSTRAINT FK_PUBLISHED_CASE_ADVERT_CASE_ID FOREIGN KEY (CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_PUBLISHED_CASE_ADVERT_ADVERT_ID FOREIGN KEY (ADVERT_ID) REFERENCES ADVERT (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_ADDITION (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      CONTENT TEXT NOT NULL,
      TYPE VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_ADDITIONS (
      CASE_CASE_ID UUID NOT NULL,
      ADDITION_ID UUID NOT NULL,
      PRIMARY KEY (CASE_CASE_ID, ADDITION_ID),
      CONSTRAINT FK_CASE_ADDITIONS_CASE_ID FOREIGN KEY (CASE_CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_ADDITIONS_ADDITION_ID FOREIGN KEY (ADDITION_ID) REFERENCES CASE_ADDITION (ID)
    );

    -- New case comment data structure
    CREATE TABLE IF NOT EXISTS CASE_ACTION (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      TITLE VARCHAR NOT NULL,
      SLUG VARCHAR NOT NULL,
      PRIMARY KEY (ID)
    );

    CREATE TABLE IF NOT EXISTS COMMENT_V2 (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      CASE_ID UUID NOT NULL,
      CASE_STATUS_ID UUID NOT NULL,
      CASE_ACTION_ID UUID NOT NULL,
      USER_CREATOR_ID UUID,
      INSTITUTION_CREATOR_ID UUID,
      CASE_STATUS_RECEIVER_ID UUID,
      USER_RECEIVER_ID UUID,
      COMMENT TEXT,
      PRIMARY KEY (ID),
      CONSTRAINT FK_COMMENT_V2_CASE_ID FOREIGN KEY (CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_COMMENT_V2_CASE_STATUS_ID FOREIGN KEY (CASE_STATUS_ID) REFERENCES CASE_STATUS (ID),
      CONSTRAINT FK_COMMENT_V2_CASE_ACTION_ID FOREIGN KEY (CASE_ACTION_ID) REFERENCES CASE_ACTION (ID),
      CONSTRAINT FK_COMMENT_V2_USER_CREATOR_ID FOREIGN KEY (USER_CREATOR_ID) REFERENCES OJOI_USER (ID),
      CONSTRAINT FK_COMMENT_V2_INSTITUTION_CREATOR_ID FOREIGN KEY (INSTITUTION_CREATOR_ID) REFERENCES ADVERT_INVOLVED_PARTY (ID),
      CONSTRAINT FK_COMMENT_V2_CASE_STATUS_RECEIVER_ID FOREIGN KEY (CASE_STATUS_RECEIVER_ID) REFERENCES CASE_STATUS (ID),
      CONSTRAINT FK_COMMENT_V2_USER_RECEIVER_ID FOREIGN KEY (USER_RECEIVER_ID) REFERENCES OJOI_USER (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_COMMENTS_V2 (
      CASE_ID UUID NOT NULL,
      COMMENT_V2_ID UUID NOT NULL,
      PRIMARY KEY (CASE_ID, COMMENT_V2_ID),
      CONSTRAINT FK_CASE_COMMENTS_V2_CASE_ID FOREIGN KEY (CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_COMMENTS_V2_COMMENT_V2_ID FOREIGN KEY (COMMENT_V2_ID) REFERENCES COMMENT_V2 (ID)
    );

    CREATE TABLE IF NOT EXISTS CASE_HISTORY (
      ID UUID NOT NULL DEFAULT UUID_GENERATE_V4 (),
      CASE_ID UUID NOT NULL,
      DEPARTMENT_ID UUID NOT NULL,
      TYPE_ID UUID NOT NULL,
      USER_ID UUID,
      STATUS_ID UUID NOT NULL,
      INSTITUTION_ID UUID NOT NULL,
      TITLE VARCHAR NOT NULL,
      HTML TEXT NOT NULL,
      REQUESTED_PUBLICATION_DATE TIMESTAMP WITH TIME ZONE,
      CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (ID),
      CONSTRAINT FK_CASE_HISTORY_CASE_ID FOREIGN KEY (CASE_ID) REFERENCES CASE_CASE (ID),
      CONSTRAINT FK_CASE_HISTORY_DEPARTMENT_ID FOREIGN KEY (DEPARTMENT_ID) REFERENCES ADVERT_DEPARTMENT (ID),
      CONSTRAINT FK_CASE_HISTORY_TYPE_ID FOREIGN KEY (TYPE_ID) REFERENCES ADVERT_TYPE (ID),
      CONSTRAINT FK_CASE_HISTORY_STATUS_ID FOREIGN KEY (STATUS_ID) REFERENCES CASE_STATUS (ID),
      CONSTRAINT FK_CASE_HISTORY_USER_ID FOREIGN KEY (USER_ID) REFERENCES OJOI_USER (ID),
      CONSTRAINT FK_CASE_HISTORY_INSTITUTION_ID FOREIGN KEY (INSTITUTION_ID) REFERENCES ADVERT_INVOLVED_PARTY (ID)
    );

    CREATE TABLE USER_INVOLVED_PARTIES (
      USER_ID UUID NOT NULL,
      INVOLVED_PARTY_ID UUID NOT NULL,
      PRIMARY KEY (USER_ID, INVOLVED_PARTY_ID),
      CONSTRAINT FK_USER_INVOLVED_PARTY_USER_ID FOREIGN KEY (USER_ID) REFERENCES OJOI_USER (ID),
      CONSTRAINT FK_USER_INVOLVED_PARTY_INVOLVED_PARTY_ID FOREIGN KEY (INVOLVED_PARTY_ID) REFERENCES ADVERT_INVOLVED_PARTY (ID)
    );


    -- Foreign keys contraint for signature
    -- Because the tables reference each other,
    -- we need to create the tables first without constraints
    -- and then add the constraints

    ALTER TABLE SIGNATURE_RECORD
    ADD CONSTRAINT FK_SIGNATURE_CHAIRMAN_ID
    FOREIGN KEY (CHAIRMAN_ID) REFERENCES SIGNATURE_MEMBER (ID);

    ALTER TABLE SIGNATURE_MEMBER
    ADD CONSTRAINT FK_SIGNATURE_MEMBER_RECORD_ID
    FOREIGN KEY (SIGNATURE_RECORD_ID) REFERENCES SIGNATURE_RECORD (ID);

    CREATE INDEX idx_created_at ON COMMENT_V2 (created_at);
    CREATE INDEX idx_created on SIGNATURE_MEMBER (created);
    CREATE INDEX idx_date on SIGNATURE_RECORD (date);

    CREATE INDEX idx_national_id on OJOI_USER (national_id);

    COMMIT;

    `)
  },

  async down(queryInterface) {
    return await queryInterface.sequelize.query(`
    BEGIN;

    ALTER TABLE SIGNATURE_MEMBER
    DROP CONSTRAINT FK_SIGNATURE_MEMBER_RECORD_ID;

    ALTER TABLE SIGNATURE_RECORD
    DROP CONSTRAINT FK_SIGNATURE_CHAIRMAN_ID;

    DROP TABLE IF EXISTS CASE_HISTORY;

    DROP TABLE IF EXISTS CASE_COMMENTS_V2;

    DROP TABLE IF EXISTS COMMENT_V2;

    DROP TABLE IF EXISTS CASE_ACTION;

    DROP TABLE IF EXISTS CASE_ADDITIONS;

    DROP TABLE IF EXISTS CASE_ADDITION;

    DROP TABLE IF EXISTS PUBLISHED_CASE_ADVERTS;

    DROP TABLE IF EXISTS CASE_ATTACHMENTS;

    DROP TABLE IF EXISTS APPLICATION_ATTACHMENTS;

    DROP TABLE IF EXISTS APPLICATION_ATTACHMENT;

    DROP TABLE IF EXISTS APPLICATION_ATTACHMENT_TYPE;

    DROP TABLE IF EXISTS SIGNATURE_MEMBER;

    DROP TABLE IF EXISTS SIGNATURE_RECORD;

    DROP TABLE IF EXISTS SIGNATURE;

    DROP TABLE IF EXISTS CASE_COMMENTS;

    DROP TABLE IF EXISTS CASE_CHANNELS;

    DROP TABLE IF EXISTS CASE_CATEGORIES;

    DROP TABLE IF EXISTS CASE_COMMENT;

    DROP TABLE IF EXISTS CASE_CASE;

    DROP TABLE IF EXISTS CASE_CHANNEL;

    DROP TABLE IF EXISTS CASE_COMMENT_TYPE;

    DROP TABLE IF EXISTS CASE_COMMUNICATION_STATUS;

    DROP TABLE IF EXISTS CASE_TAG;

    DROP TABLE IF EXISTS CASE_STATUS;

    DROP TABLE IF EXISTS CATEGORY_DEPARTMENT;

    DROP TABLE IF EXISTS OJOI_USER;

    DROP TABLE IF EXISTS USER_INVOLVED_PARTIES;

    DROP TABLE IF EXISTS USER_ROLE;

    DROP TABLE IF EXISTS ADVERT_ATTACHMENTS;

    DROP TABLE IF EXISTS ADVERT_CATEGORIES;

    DROP TABLE IF EXISTS ADVERT_CORRECTION;

    DROP TABLE IF EXISTS ADVERT;

    DROP TABLE IF EXISTS ADVERT_INVOLVED_PARTY;

    DROP TABLE IF EXISTS ADVERT_STATUS;

    DROP TABLE IF EXISTS CATEGORY_CATEGORIES;

    DROP TABLE IF EXISTS ADVERT_CATEGORY;

    DROP TABLE IF EXISTS ADVERT_MAIN_CATEGORY;

    DROP TABLE IF EXISTS ADVERT_TYPE;

    DROP TABLE IF EXISTS ADVERT_MAIN_TYPE;

    DROP TABLE IF EXISTS ADVERT_DEPARTMENT;

    DROP TABLE IF EXISTS CASE_TRANSACTION;

    DROP TABLE IF EXISTS APPLICATION_FEE_CODES;

    DROP TRIGGER IF EXISTS BEFORE_DELETE_SIGNATURE_MEMBER ON SIGNATURE_MEMBER;

    COMMIT;

    `)
  },
}
