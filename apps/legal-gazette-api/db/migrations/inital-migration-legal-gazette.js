'use strict'

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface) {
    return await queryInterface.sequelize.query(`
    BEGIN;

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    CREATE TYPE ADVERT_VERSION AS ENUM (
      'A',
      'B',
      'C'
    );

    CREATE TYPE APPLICATION_STATUS AS ENUM (
      'DRAFT',
      'SUBMITTED'
    );

    CREATE TYPE APPLICATION_TYPE AS ENUM (
      'COMMON',
      'RECALL_BANKRUPTCY',
      'RECALL_DECEASED'
    );

    CREATE TABLE LEGAL_GAZETTE_USERS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      NATIONAL_ID TEXT NOT NULL UNIQUE,
      FIRST_NAME TEXT NOT NULL,
      LAST_NAME TEXT NOT NULL,
      EMAIL TEXT NOT NULL UNIQUE,
      PHONE TEXT DEFAULT NULL
    );

    CREATE TABLE CASES (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      ASSIGNED_USER_ID UUID DEFAULT NULL REFERENCES LEGAL_GAZETTE_USERS(ID) ON DELETE SET NULL,
      INVOLVED_PARTY_NATIONAL_ID TEXT NOT NULL,

      CASE_NUMBER TEXT NOT NULL UNIQUE
    );

    CREATE TABLE COURT_DISTRICT (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE
    );

    CREATE TABLE ADVERT_TYPE (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE
    );

    CREATE TABLE ADVERT_CATEGORY (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE,

      ADVERT_TYPE_ID UUID NOT NULL REFERENCES ADVERT_TYPE(ID) ON DELETE CASCADE
    );

    CREATE TABLE ADVERT_STATUS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE
    );

    CREATE TABLE SETTLEMENT (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      LIQUIDATOR_NAME TEXT NOT NULL,
      LIQUIDATOR_LOCATION TEXT NOT NULL,

      NAME TEXT NOT NULL,
      NATIONAL_ID TEXT NOT NULL,
      ADDRESS TEXT NOT NULL,
      DEADLINE_DATE TIMESTAMPTZ DEFAULT NULL,
      DATE_OF_DEATH TIMESTAMPTZ DEFAULT NULL
    );

    CREATE TABLE ADVERT (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      CASE_ID UUID NOT NULL REFERENCES CASES(ID),
      SETTLEMENT_ID UUID DEFAULT NULL REFERENCES SETTLEMENT(ID),
      COURT_DISTRICT_ID UUID DEFAULT NULL REFERENCES COURT_DISTRICT(ID),
      ISLAND_IS_APPLICATION_ID UUID DEFAULT NULL,

      ADVERT_TYPE_ID UUID NOT NULL REFERENCES ADVERT_TYPE(ID),
      ADVERT_CATEGORY_ID UUID NOT NULL REFERENCES ADVERT_CATEGORY(ID),
      ADVERT_STATUS_ID UUID NOT NULL REFERENCES ADVERT_STATUS(ID) DEFAULT '63726fce-edcf-412d-85e8-087e99c592f2',

      PUBLICATION_NUMBER TEXT UNIQUE DEFAULT NULL,
      VERSION ADVERT_VERSION NOT NULL DEFAULT 'A',

      SCHEDULED_AT TIMESTAMPTZ NOT NULL,
      PUBLISHED_AT TIMESTAMPTZ DEFAULT NULL,

      TITLE TEXT NOT NULL,
      HTML TEXT NOT NULL,
      CREATED_BY TEXT NOT NULL,

      PAID BOOLEAN NOT NULL DEFAULT FALSE,

      ADDITIONAL_TEXT TEXT DEFAULT NULL,
      CAPTION TEXT DEFAULT NULL,

      SIGNATURE_NAME TEXT DEFAULT NULL,
      SIGNATURE_ON_BEHALF_OF TEXT DEFAULT NULL,
      SIGNATURE_LOCATION TEXT DEFAULT NULL,
      SIGNATURE_DATE TIMESTAMPTZ DEFAULT NULL
    );

    CREATE TABLE ADVERT_PUBLICATIONS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      ADVERT_ID UUID NOT NULL REFERENCES ADVERT(ID),
      SCHEDULED_AT TIMESTAMPTZ NOT NULL,
      PUBLISHED_AT TIMESTAMPTZ DEFAULT NULL,
      VERSION_NUMBER INTEGER NOT NULL,
      UNIQUE (ADVERT_ID, VERSION_NUMBER)
    );

    CREATE TABLE COMMUNICATION_CHANNEL (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      EMAIL TEXT NOT NULL,
      NAME TEXT,
      PHONE TEXT,

      ADVERT_ID UUID NOT NULL REFERENCES ADVERT(ID)
    );

    CREATE TABLE APPLICATION (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      SUBMITTED_BY_NATIONAL_ID TEXT NOT NULL,
      STATUS APPLICATION_STATUS NOT NULL DEFAULT 'DRAFT',

      ISLAND_IS_APPLICATION_ID UUID DEFAULT NULL,

      APPLICATION_TYPE APPLICATION_TYPE NOT NULL,
      CATEGORY_ID UUID DEFAULT NULL REFERENCES ADVERT_CATEGORY(ID),
      CAPTION TEXT DEFAULT NULL,
      ADDITIONAL_TEXT TEXT DEFAULT NULL,
      JUDGMENT_DATE TIMESTAMPTZ DEFAULT NULL,
      HTML TEXT DEFAULT NULL,

      SIGNATURE_NAME TEXT DEFAULT NULL,
      SIGNATURE_ON_BEHALF_OF TEXT DEFAULT NULL,
      SIGNATURE_LOCATION TEXT DEFAULT NULL,
      SIGNATURE_DATE TIMESTAMPTZ DEFAULT NULL,

      LIQUIDATOR_NAME TEXT DEFAULT NULL,
      LIQUIDATOR_LOCATION TEXT DEFAULT NULL,
      LIQUIDATOR_ON_BEHALF_OF TEXT DEFAULT NULL,

      SETTLEMENT_NAME TEXT DEFAULT NULL,
      SETTLEMENT_NATIONAL_ID TEXT DEFAULT NULL,
      SETTLEMENT_ADDRESS TEXT DEFAULT NULL,
      SETTLEMENT_DEADLINE_DATE TIMESTAMPTZ DEFAULT NULL,
      SETTLEMENT_DATE_OF_DEATH TIMESTAMPTZ DEFAULT NULL,

      DIVISION_MEETING_DATE TIMESTAMPTZ DEFAULT NULL,
      DIVISION_MEETING_LOCATION TEXT DEFAULT NULL,

      COMMUNICATION_CHANNELS JSONB DEFAULT '[]'::jsonb,
      PUBLISHING_DATES TIMESTAMP WITH TIME ZONE[] DEFAULT array[]::timestamptz[],

      COURT_DISTRICT_ID UUID REFERENCES COURT_DISTRICT(ID),
      CASE_ID UUID NOT NULL REFERENCES CASES(ID)
    );

    CREATE TABLE LEGAL_GAZETTE_SUBSCRIBERS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      NATIONAL_ID TEXT NOT NULL UNIQUE,
      IS_ACTIVE BOOLEAN NOT NULL DEFAULT FALSE,

      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ
    );

    CREATE INDEX idx_advert_type_title_asc ON ADVERT_TYPE (TITLE ASC);

    CREATE INDEX idx_advert_category_title_asc ON ADVERT_CATEGORY (TITLE ASC);

    CREATE INDEX idx_advert_status_title_asc ON ADVERT_STATUS (TITLE ASC);

    CREATE INDEX idx_user_national_id ON LEGAL_GAZETTE_USERS (NATIONAL_ID);

    CREATE INDEX idx_advert_status_type_category ON advert (advert_status_id, advert_type_id, advert_category_id);

    CREATE INDEX idx_advert_scheduled_at ON advert (scheduled_at ASC);

    CREATE INDEX idx_advert_publications_advert_id ON ADVERT_PUBLICATIONS (ADVERT_ID);
    CREATE INDEX idx_advert_publications_scheduled_at_asc ON ADVERT_PUBLICATIONS (SCHEDULED_AT ASC);
    CREATE INDEX idx_advert_publications_published_at_desc ON ADVERT_PUBLICATIONS (PUBLISHED_AT DESC);

    COMMIT;

    `)
  },

  async down(queryInterface) {
    return await queryInterface.sequelize.query(`
    BEGIN;

    DROP INDEX IF EXISTS idx_advert_scheduled_at;
    DROP INDEX IF EXISTS idx_advert_status_type_category;
    DROP INDEX IF EXISTS idx_user_national_id;
    DROP INDEX IF EXISTS idx_advert_status_title_asc;
    DROP INDEX IF EXISTS idx_advert_category_title_asc;
    DROP INDEX IF EXISTS idx_advert_type_title_asc;
    DROP INDEX IF EXISTS idx_advert_publications_advert_id;
    DROP INDEX IF EXISTS idx_advert_publications_scheduled_at_asc;
    DROP INDEX IF EXISTS idx_advert_publications_published_at_desc;

    DROP TABLE IF EXISTS LEGAL_GAZETTE_SUBSCRIBERS;
    DROP TABLE IF EXISTS APPLICATION;
    DROP TABLE IF EXISTS COMMUNICATION_CHANNEL;
    DROP TABLE IF EXISTS ADVERT;
    DROP TABLE IF EXISTS SETTLEMENT;
    DROP TABLE IF EXISTS ADVERT_STATUS;
    DROP TABLE IF EXISTS ADVERT_CATEGORY;
    DROP TABLE IF EXISTS ADVERT_TYPE;
    DROP TABLE IF EXISTS COURT_DISTRICT;
    DROP TABLE IF EXISTS CASES;
    DROP TABLE IF EXISTS LEGAL_GAZETTE_USERS;

    -- Drop types and extensions
    DROP TYPE IF EXISTS APPLICATION_STATUS;
    DROP TYPE IF EXISTS ADVERT_VERSION;
    DROP EXTENSION IF EXISTS "uuid-ossp";

    COMMIT;
    `)
  },
}
