'use strict'

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface) {
    return await queryInterface.sequelize.query(`
    BEGIN;

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    CREATE TYPE USER_ROLE AS ENUM (
      'ADMIN',
      'USER'
    );

    CREATE TYPE ADVERT_VERSION AS ENUM (
      'A',
      'B',
      'C'
    );

    CREATE TABLE CASES (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      APPLICATION_ID UUID DEFAULT NULL,
      ASSIGNED_USER_ID UUID DEFAULT NULL,

      CASE_NUMBER TEXT NOT NULL UNIQUE
    );

    CREATE TABLE LEGAL_GAZETTE_USER_ROLES (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE USER_ROLE NOT NULL,
      SLUG TEXT NOT NULL UNIQUE
    );

    CREATE TABLE LEGAL_GAZETTE_INSTITUTIONS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE,
      NATIONAL_ID TEXT NOT NULL UNIQUE
    );

    CREATE TABLE LEGAL_GAZETTE_USERS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      NATIONAL_ID TEXT NOT NULL UNIQUE,
      FIRST_NAME TEXT NOT NULL,
      LAST_NAME TEXT NOT NULL,
      EMAIL TEXT NOT NULL UNIQUE,
      PHONE TEXT DEFAULT NULL,
      LAST_SUBMISSION_DATE TIMESTAMPTZ DEFAULT NULL,

      USER_ROLE_ID UUID NOT NULL REFERENCES LEGAL_GAZETTE_USER_ROLES(ID)
    );

    CREATE TABLE LEGAL_GAZETTE_USER_INSTITUTIONS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      USER_ID UUID NOT NULL REFERENCES LEGAL_GAZETTE_USERS(ID) DEFAULT '93bc4ffa-d3c2-4519-abd2-5f4bcbad700e',
      INSTITUTION_ID UUID NOT NULL REFERENCES LEGAL_GAZETTE_INSTITUTIONS(ID),

      UNIQUE (USER_ID, INSTITUTION_ID)
    );

    CREATE TABLE ADVERT_TYPE (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE
    );

    CREATE TABLE ADVERT_CATEGORY (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE,

      ADVERT_TYPE_ID UUID NOT NULL REFERENCES ADVERT_TYPE(ID) ON DELETE CASCADE
    );

    CREATE TABLE ADVERT_STATUS (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      TITLE TEXT NOT NULL,
      SLUG TEXT NOT NULL UNIQUE
    );

    CREATE TABLE COMMUNICATION_CHANNEL (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      EMAIL TEXT NOT NULL,
      NAME TEXT,
      PHONE TEXT,

      CASE_ID UUID NOT NULL REFERENCES CASES(ID)
    );

    CREATE TABLE ADVERT (
      ID UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      ADVERT_TYPE_ID UUID NOT NULL REFERENCES ADVERT_TYPE(ID),
      ADVERT_CATEGORY_ID UUID NOT NULL REFERENCES ADVERT_CATEGORY(ID),
      ADVERT_STATUS_ID UUID NOT NULL REFERENCES ADVERT_STATUS(ID) DEFAULT 'cd3bf301-52a1-493e-8c80-a391c310c840',

      SCHEDULED_AT TIMESTAMPTZ NOT NULL,
      PUBLISHED_AT TIMESTAMPTZ DEFAULT NULL,
      VERSION ADVERT_VERSION NOT NULL DEFAULT 'A',

      TITLE TEXT NOT NULL,
      HTML TEXT NOT NULL,

      PAID BOOLEAN NOT NULL DEFAULT FALSE,

      CASE_ID UUID NOT NULL REFERENCES CASES(ID)
    );

    CREATE TABLE COMMON_ADVERT (
      ID UUID PRIMARY KEY REFERENCES ADVERT(ID),
      CREATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      UPDATED_AT TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
      DELETED_AT TIMESTAMPTZ,

      CAPTION TEXT NOT NULL,
      SIGNATURE_LOCATION TEXT NOT NULL,
      SIGNATURE_NAME TEXT NOT NULL,
      SIGNATURE_DATE TIMESTAMPTZ NOT NULL
    );

    CREATE INDEX idx_advert_type_title_asc ON ADVERT_TYPE (TITLE ASC);

    CREATE INDEX idx_advert_category_title_asc ON ADVERT_CATEGORY (TITLE ASC);

    CREATE INDEX idx_advert_status_title_asc ON ADVERT_STATUS (TITLE ASC);

    CREATE INDEX idx_user_national_id ON LEGAL_GAZETTE_INSTITUTIONS (NATIONAL_ID);

    COMMIT;

    `)
  },

  async down(queryInterface) {
    return await queryInterface.sequelize.query(`
    BEGIN;

    DROP INDEX IF EXISTS idx_advert_type_title_asc;
    DROP INDEX IF EXISTS idx_advert_category_title_asc;
    DROP INDEX IF EXISTS idx_advert_status_title_asc;

    DROP TABLE IF EXISTS COMMON_ADVERT;

    DROP TABLE IF EXISTS COMMUNICATION_CHANNEL;

    DROP TABLE IF EXISTS ADVERT;

    DROP TABLE IF EXISTS ADVERT_STATUS;

    DROP TABLE IF EXISTS ADVERT_CATEGORY;

    DROP TABLE IF EXISTS ADVERT_TYPE;

    DROP TABLE IF EXISTS CASES;

    DROP TABLE IF EXISTS LEGAL_GAZETTE_USER_INSTITUTIONS;

    DROP TABLE IF EXISTS LEGAL_GAZETTE_USERS;

    DROP TABLE IF EXISTS LEGAL_GAZETTE_INSTITUTIONS;

    DROP TABLE IF EXISTS LEGAL_GAZETTE_USER_ROLES;

    DROP TYPE IF EXISTS USER_ROLE;

    DROP TYPE IF EXISTS ADVERT_VERSION;

    DROP EXTENSION IF EXISTS "uuid-ossp";

    COMMIT;

    `)
  },
}
