#!/bin/bash

set -euo pipefail

SUBMODULE_PATH="submodules/monorepo"
SPARSE_CHECKOUT_PATH="${SUBMODULE_PATH}/.git/info/sparse-checkout"
DESIRED_SPARSE_PATTERN="libs/shared/*"
CURRENT_PINNED_SHA_PATH="submodules/.monorepo-sha"

git submodule update --init "${SUBMODULE_PATH}"

git -C "${SUBMODULE_PATH}" fetch

if [ -f "$CURRENT_PINNED_SHA_PATH" ]; then
  CURRENT_PINNED_SHA=$(cat "$CURRENT_PINNED_SHA_PATH")
  echo "New commits in ${DESIRED_SPARSE_PATTERN} since last pinned SHA (${CURRENT_PINNED_SHA}):"
  git -C "${SUBMODULE_PATH}" log --oneline "${CURRENT_PINNED_SHA}..origin/main" -- "${DESIRED_SPARSE_PATTERN}"
fi

git -C "${SUBMODULE_PATH}" config core.sparseCheckout true

# Check and set the sparse-checkout configuration only if it's different.
if ! grep -Fxq "$DESIRED_SPARSE_PATTERN" "$SPARSE_CHECKOUT_PATH"; then
  echo "$DESIRED_SPARSE_PATTERN" >"$SPARSE_CHECKOUT_PATH"
  git -C "${SUBMODULE_PATH}" read-tree -mu HEAD
fi
