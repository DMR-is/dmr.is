name: 'üöÄ Update Terragrunt Deployment'
description: 'Deploy using Terragrunt apply in infrastructure repository (parallel execution with logs)'

inputs:
  PAT:
    description: 'The personal access token to use'
    required: true
  ENV:
    description: 'The environment to deploy to'
    required: true
  VERSION_TAG:
    description: 'The version tag to deploy'
    required: true
  INFRA_REPO:
    description: 'The infrastructure repository to deploy to'
    required: true
    default: 'DMR-is/infrastructure'

runs:
  using: 'composite'
  steps:
    - uses: Homebrew/actions/setup-homebrew@master
      name: ‚òïÔ∏èSet up Homebrew
      id: set-up-homebrew

    - name: üóÑÔ∏èCache Homebrew Bundler RubyGems
      id: cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.set-up-homebrew.outputs.gems-path }}
        key: ubuntu-latest-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
        restore-keys: ubuntu-latest-rubygems-

    - name: üì• Install Terragrunt
      shell: bash
      run: brew install terragrunt tfenv

    - name: Setup Terraform v1.11.2
      uses: hashicorp/setup-Terraform@v3
      with:
        terraform_version: 1.11.2

    - name: Terragrunt version
      shell: bash
      run: terragrunt --version

    - name: Terraform version
      shell: bash
      run: terraform --version

    - name: üìÅ Checkout
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.INFRA_REPO }}
        token: ${{ inputs.PAT }}
        path: infrastructure

    - name: üöÄ Deploy services in parallel
      shell: bash
      run: |
        set -euo pipefail
        cd infrastructure/utgafa

        echo "üöÄ Starting parallel deployments..."

        stdbuf -oL -eL ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_api \
          --config-var-name official_journal_api_version_tag 2>&1 | \
          stdbuf -oL -eL sed 's/^/[official_journal_api] /' &

        stdbuf -oL -eL ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_admin_api \
          --config-var-name official_journal_admin_api_version_tag 2>&1 | \
          stdbuf -oL -eL sed 's/^/[official_journal_admin_api] /' &

        stdbuf -oL -eL ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_application_api \
          --config-var-name official_journal_application_api_version_tag 2>&1 | \
          stdbuf -oL -eL sed 's/^/[official_journal_application_api] /' &

        stdbuf -oL -eL ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_web \
          --config-var-name official_journal_web_version_tag 2>&1 | \
          stdbuf -oL -eL sed 's/^/[official_journal_web] /' &

        stdbuf -oL -eL ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target regulations_api \
          --config-var-name regulations_api_version_tag 2>&1 | \
          stdbuf -oL -eL sed 's/^/[regulations_api] /' &

        FAIL=0
        for pid in $(jobs -p); do
          wait "$pid" || FAIL=1
        done

        if [ "$FAIL" -ne 0 ]; then
          echo "‚ùå One or more deployments failed"
          exit 1
        fi

        echo "‚úÖ All parallel deployments completed"


    - name: üíæ Commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 'chore: update √ötg√°fa to ${{ inputs.VERSION_TAG }}'
        branch: main
        skip_fetch: false
        repository: infrastructure
