name: 'ğŸš€ Update Terragrunt Deployment'
description: 'Deploy using Terragrunt apply in infrastructure repository (parallel execution with logs)'

inputs:
  PAT:
    description: 'The personal access token to use'
    required: true
  ENV:
    description: 'The environment to deploy to'
    required: true
  VERSION_TAG:
    description: 'The version tag to deploy'
    required: true
  INFRA_REPO:
    description: 'The infrastructure repository to deploy to'
    required: true
    default: 'DMR-is/infrastructure'

runs:
  using: 'composite'
  steps:
    - uses: Homebrew/actions/setup-homebrew@master
      name: â˜•ï¸Set up Homebrew
      id: set-up-homebrew

    - name: ğŸ—„ï¸Cache Homebrew Bundler RubyGems
      id: cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.set-up-homebrew.outputs.gems-path }}
        key: ubuntu-latest-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
        restore-keys: ubuntu-latest-rubygems-

    - name: ğŸ“¥ Install Terragrunt
      shell: bash
      run: brew install terragrunt tfenv

    - name: Setup Terraform v1.11.2
      uses: hashicorp/setup-Terraform@v3
      with:
        terraform_version: 1.11.2

    - name: Terragrunt version
      shell: bash
      run: terragrunt --version

    - name: Terraform version
      shell: bash
      run: terraform --version

    - name: ğŸ“ Checkout
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.INFRA_REPO }}
        token: ${{ inputs.PAT }}
        path: infrastructure

    - name: ğŸš€ Deploy services with Terragrunt
      shell: bash
      run: |
        set -euo pipefail
        cd infrastructure/utgafa

        echo "ğŸš€ Deploying services with Terragrunt run --all..."

        ../scripts/apply_services.sh \
          --environment ${{ inputs.ENV }} \
          --version ${{ inputs.VERSION_TAG }} \
          --parallelism 5 \
          --commit false \
          --ignore-dirty true \
          --service official_journal_api:official_journal_api_version_tag \
          --service official_journal_admin_api:official_journal_admin_api_version_tag \
          --service official_journal_application_api:official_journal_application_api_version_tag \
          --service official_journal_web:official_journal_web_version_tag \
          --service regulations_api:regulations_api_version_tag \
          --service legal_gazette_api:legal_gazette_api_version_tag \
          --service legal_gazette_web:legal_gazette_web_version_tag \
          --service legal_gazette_application_web:legal_gazette_application_web_version_tag \
          --service legal_gazette_public_web:legal_gazette_public_web_version_tag

        echo "âœ… All services deployed successfully!"


    - name: ğŸ’¾ Commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 'chore: update ÃštgÃ¡fa to ${{ inputs.VERSION_TAG }}'
        branch: main
        skip_fetch: false
        repository: infrastructure
