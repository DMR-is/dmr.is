name: 'üöÄ Update Terragrunt Deployment'
description: 'Deploy using Terragrunt apply in infrastructure repository (parallel execution with logs)'

inputs:
  PAT:
    description: 'The personal access token to use'
    required: true
  ENV:
    description: 'The environment to deploy to'
    required: true
  VERSION_TAG:
    description: 'The version tag to deploy'
    required: true
  INFRA_REPO:
    description: 'The infrastructure repository to deploy to'
    required: true
    default: 'DMR-is/infrastructure'

runs:
  using: 'composite'
  steps:
    - uses: Homebrew/actions/setup-homebrew@master
      name: ‚òïÔ∏èSet up Homebrew
      id: set-up-homebrew

    - name: üóÑÔ∏èCache Homebrew Bundler RubyGems
      id: cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.set-up-homebrew.outputs.gems-path }}
        key: ubuntu-latest-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
        restore-keys: ubuntu-latest-rubygems-

    - name: üì• Install Terragrunt
      shell: bash
      run: brew install terragrunt tfenv

    - name: Setup Terraform v1.10.1
      uses: hashicorp/setup-Terraform@v3
      with:
        terraform_version: 1.10.1

    - name: Terragrunt version
      shell: bash
      run: terragrunt --version

    - name: Terraform version
      shell: bash
      run: terraform --version

    - name: üìÅ Checkout
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.INFRA_REPO }}
        token: ${{ inputs.PAT }}
        path: infrastructure

    - name: üöÄ Deploy services in parallel
      shell: bash
      run: |
        cd infrastructure/utgafa
        
        # Create log directory
        mkdir -p /tmp/deploy_logs
        
        echo "üöÄ Starting parallel deployments..."
        
        # Run all deployments in parallel with output capture
        (
          echo "[official_journal_api] Starting deployment..."
          ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_api \
          --config-var-name official_journal_api_version_tag 2>&1 | \
          sed 's/^/[official_journal_api] /'
          echo "[official_journal_api] Deployment completed with exit code: ${PIPESTATUS[0]}"
        ) > /tmp/deploy_logs/official_journal_api.log 2>&1 &
        
        (
          echo "[official_journal_admin_api] Starting deployment..."
          ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_admin_api \
          --config-var-name official_journal_admin_api_version_tag 2>&1 | \
          sed 's/^/[official_journal_admin_api] /'
          echo "[official_journal_admin_api] Deployment completed with exit code: ${PIPESTATUS[0]}"
        ) > /tmp/deploy_logs/official_journal_admin_api.log 2>&1 &
        
        (
          echo "[official_journal_application_api] Starting deployment..."
          ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_application_api \
          --config-var-name official_journal_application_api_version_tag 2>&1 | \
          sed 's/^/[official_journal_application_api] /'
          echo "[official_journal_application_api] Deployment completed with exit code: ${PIPESTATUS[0]}"
        ) > /tmp/deploy_logs/official_journal_application_api.log 2>&1 &
        
        (
          echo "[official_journal_web] Starting deployment..."
          ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target official_journal_web \
          --config-var-name official_journal_web_version_tag 2>&1 | \
          sed 's/^/[official_journal_web] /'
          echo "[official_journal_web] Deployment completed with exit code: ${PIPESTATUS[0]}"
        ) > /tmp/deploy_logs/official_journal_web.log 2>&1 &
        
        (
          echo "[regulations_api] Starting deployment..."
          ../scripts/update_tag.sh \
          --environment ${{ inputs.ENV }} \
          --update-value ${{ inputs.VERSION_TAG }} \
          --commit false \
          --ignore-dirty true \
          --target regulations_api \
          --config-var-name regulations_api_version_tag 2>&1 | \
          sed 's/^/[regulations_api] /'
          echo "[regulations_api] Deployment completed with exit code: ${PIPESTATUS[0]}"
        ) > /tmp/deploy_logs/regulations_api.log 2>&1 &
        
        # Store background job PIDs
        PIDS="$!"
        
        # Wait for all background jobs and show live output
        while kill -0 $PIDS 2>/dev/null; do
          for log_file in /tmp/deploy_logs/*.log; do
            if [[ -f "$log_file" ]]; then
              tail -n +1 "$log_file" 2>/dev/null || true
            fi
          done
          sleep 2
          echo "‚è≥ Deployments in progress..."
        done
        
        # Final output of all logs
        echo "üìã Final deployment logs:"
        for log_file in /tmp/deploy_logs/*.log; do
          if [[ -f "$log_file" ]]; then
            echo "\n=== $(basename "$log_file" .log) ==="
            cat "$log_file"
          fi
        done
        
        echo "‚úÖ All parallel deployments completed"


    - name: üíæ Commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 'chore: update √ötg√°fa to ${{ inputs.VERSION_TAG }}'
        branch: main
        skip_fetch: false
        repository: infrastructure
